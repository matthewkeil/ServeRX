"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const _1 = require("./");
class Path extends Array {
    constructor(arg) {
        super();
        this.id = this.last.id;
        this.val = this.last.val;
        this.is = (here) => Path.match(this, here);
        let results = Path.validate(arg, false);
        if (!results || (results instanceof Error))
            throw results || new _1.PathError('cannot built Path with an invalid Input', arg);
        this.concat(results.map(seg => new _1.Segment(seg)));
    }
    static validate(arg, create = true) {
        let finalize = (path) => create
            ? new Path(path.map(seg => new _1.Segment(seg)))
            : [...path].map(seg => [...seg]);
        if (arg instanceof Path)
            return finalize(arg);
        let error;
        let test;
        let valid = [];
        if (util_1.isString(arg))
            if (Path.ValidPath.test(arg))
                test = arg.split('/').filter(value => value !== '');
            else
                return undefined;
        test = test
            ? test
            : arg;
        if (util_1.isArray(test)) {
            test.forEach((segment, index) => {
                let results = Path.validSegment(segment);
                if (!results || util_1.isError(results))
                    error = error || new _1.PathError('invalid segment found', segment);
                else
                    valid.push(results);
                if (segment[0] === '~' && (index !== 0))
                    error = new _1.PathError('root segment must be at the beginning of a path', arg);
            });
        }
        return valid.length === 0
            ? undefined
            : error
                ? error
                : finalize(valid);
    }
    static match(_path, _here) {
        let results = [];
        let match = [results, undefined];
        let path = Path.validate(_path);
        if (!path || util_1.isError(path))
            return [results.concat('no'), path || new _1.PathError('path is invalid', _path)];
        let here = Path.validate(_here);
        if (!here || util_1.isError(here))
            return [results.concat('no'), here || new _1.PathError('here is invalid', _here)];
        if (path.length >= here.length) {
            for (let i = 0; i < here.length; i++) {
                let result = path[i].is(here[i]);
                results.push(result);
                if (result === 'no') {
                    match[1] = new _1.PathError('path not along this path', [_path, _here]);
                    break;
                }
            }
        }
        else
            match[1] = new _1.PathError('path is shorter than the route here', [_path, _here]);
        match[1] = match[1] || path;
        return match;
    }
    get last() {
        return this[this.length - 1];
    }
    set last(arg) {
        let valid = Path.validSegment(arg);
        if (!valid || util_1.isError(valid))
            throw new _1.PathError('cannot set path.last to an invalid segment', arg);
        this[this.length - 1] = new _1.Segment(valid);
    }
    get isFromRoot() {
        return this[0] && (this[0][0] === '~');
    }
}
Path.ValidIdentifier = _1.Segment.ValidIdentifier;
Path.ValidValue = _1.Segment.ValidValue;
Path.ValidSegment = _1.Segment.ValidSegment;
Path.validId = _1.Segment.validId;
Path.validValue = _1.Segment.validValue;
Path.validSegment = _1.Segment.valid;
Path.ValidPath = /^(~?)(?:\/?([^~?#\/]*))*$/;
exports.Path = Path;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGF0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlBhdGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSwrQkFJYztBQUVkLHlCQUdZO0FBTVosVUFBa0IsU0FBUSxLQUFjO0lBMkd2QyxZQUFZLEdBQVE7UUFDbkIsS0FBSyxFQUFFLENBQUM7UUFMRixPQUFFLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7UUFFbEIsUUFBRyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBWXBCLE9BQUUsR0FBRyxDQUFDLElBQVcsS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQVBuRCxJQUFJLE9BQU8sR0FBZ0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDckQsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLFlBQVksS0FBSyxDQUFDLENBQUM7WUFDMUMsTUFBTSxPQUFPLElBQUksSUFBSSxZQUFTLENBQUMseUNBQXlDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFaEYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxJQUFJLFVBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkQsQ0FBQztJQXhHTSxNQUFNLENBQUMsUUFBUSxDQUFDLEdBQVEsRUFBRSxTQUFrQixJQUFJO1FBRXRELElBQUksUUFBUSxHQUFHLENBQUMsSUFBaUIsS0FBSyxNQUFNO2NBQ3pDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLElBQUksVUFBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Y0FDM0MsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7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